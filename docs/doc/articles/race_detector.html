<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>



  
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#00add8">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Material+Icons">
<link rel="stylesheet" href="../../css/styles.css">

  
  
  
<script src="../../go.dev/js/site.js"></script>
<meta name="og:url" content="https://go.dev/doc/articles/race_detector">
<meta name="og:title" content="Data Race Detector - The Go Programming Language">
<title>Data Race Detector - Go中文网 Go语言中文网 golang</title>

 
<meta name="og:description" content="Go中文网 Go语言中文网 golang ;Go 是一种开源编程语言，可以轻松构建简单、可靠和高效的软件">
 
<meta name="description" content="Go中文网 Go语言中文网 golang ;Go 是一种开源编程语言，可以轻松构建简单、可靠和高效的软件.">

 
<meta name="og:image" content="https://go.dev/doc/gopher/gopher5logo.jpg">
<meta name="twitter:image" content="https://go.dev/doc/gopher/gopherbelly300.jpg">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@golang">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4638549725433695" crossorigin="anonymous"></script><script src="https://www.p2hp.com/tj.js"></script></head>
<body class="Site">
  

  


<header class="Site-header js-siteHeader">
  <div class="Header Header--dark">
    <nav class="Header-nav">
      <a href="https://go.p2hp.com/" title="Go中文网">
        <img
          class="js-headerLogo Header-logo"
          src="../../go.dev/images/go-logo-white.svg"
          alt="Go">
      </a>
      <div class="Header-rightContent">
        <ul class="Header-menu">
          <li class="Header-menuItem ">
            <a href="https://go.p2hp.com/solutions/" target="">为什么用Go</a>
          </li>
          <li class="Header-menuItem ">
            <a href="https://go.p2hp.com/learn/" target="">快速开始</a>
          </li>
          <li class="Header-menuItem  Header-menuItem--active">
            <a href="../index.html" target="">文档</a>
          </li>
          <li class="Header-menuItem ">
            <a href="https://pkg.go.dev" target="_blank">包</a>
          </li>
          <li class="Header-menuItem ">
            <a href="https://go.p2hp.com/play/" target="">在线运行</a>
          </li>
          <li class="Header-menuItem ">
            <a href="https://go.p2hp.com/blog/" target="">博客</a>
          </li>
        </ul>
        <button class="Header-navOpen js-headerMenuButton Header-navOpen--white" aria-label="Open navigation.">
        </button>
      </div>
    </nav>
    
  </div>
</header>
<aside class="NavigationDrawer js-header">
  <nav class="NavigationDrawer-nav">
    <div class="NavigationDrawer-header">
      <a href="https://go.p2hp.com/">
        <img class="NavigationDrawer-logo" src="../../go.dev/images/go-logo-blue.svg" alt="Go.">
      </a>
    </div>
    <ul class="NavigationDrawer-list">
        <li class="NavigationDrawer-listItem ">
          <a href="https://go.p2hp.com/solutions/">为什么用Go</a>
        </li>
        <li class="NavigationDrawer-listItem ">
          <a href="https://go.p2hp.com/learn/">快速开始</a>
        </li>
        <li class="NavigationDrawer-listItem  NavigationDrawer-listItem--active">
          <a href="../index.html">文档</a>
        </li>
        <li class="NavigationDrawer-listItem ">
          <a href="https://pkg.go.dev">包</a>
        </li>
        <li class="NavigationDrawer-listItem ">
          <a href="https://go.p2hp.com/play/">在线运行</a>
        </li>
        <li class="NavigationDrawer-listItem ">
          <a href="https://go.p2hp.com/blog/">博客</a>
        </li>
    </ul>
  </nav>
</aside>
<div class="NavigationDrawer-scrim js-scrim" role="presentation"></div>
<main class="SiteContent SiteContent--default">
  


<article class="Doc Article">


<h1>Data Race Detector</h1>






<div id="nav" class="TOC"></div>






<h2 id="Introduction">Introduction</h2>

<p>
Data races are among the most common and hardest to debug types of bugs in concurrent systems.
A data race occurs when two goroutines access the same variable concurrently and at least one of the accesses is a write.
See the <a href="https://go.p2hp.com/ref/mem/">The Go Memory Model</a> for details.
</p>

<p>
Here is an example of a data race that can lead to crashes and memory corruption:
</p>

<pre>
func main() {
	c := make(chan bool)
	m := make(map[string]string)
	go func() {
		m["1"] = "a" // First conflicting access.
		c &lt;- true
	}()
	m["2"] = "b" // Second conflicting access.
	&lt;-c
	for k, v := range m {
		fmt.Println(k, v)
	}
}
</pre>

<h2 id="Usage">Usage</h2>

<p>
To help diagnose such bugs, Go includes a built-in data race detector.
To use it, add the <code>-race</code> flag to the go command:
</p>

<pre>
$ go test -race mypkg    // to test the package
$ go run -race mysrc.go  // to run the source file
$ go build -race mycmd   // to build the command
$ go install -race mypkg // to install the package
</pre>

<h2 id="Report_Format">Report Format</h2>

<p>
When the race detector finds a data race in the program, it prints a report.
The report contains stack traces for conflicting accesses, as well as stacks where the involved goroutines were created.
Here is an example:
</p>

<pre>
WARNING: DATA RACE
Read by goroutine 185:
  net.(*pollServer).AddFD()
      src/net/fd_unix.go:89 +0x398
  net.(*pollServer).WaitWrite()
      src/net/fd_unix.go:247 +0x45
  net.(*netFD).Write()
      src/net/fd_unix.go:540 +0x4d4
  net.(*conn).Write()
      src/net/net.go:129 +0x101
  net.func·060()
      src/net/timeout_test.go:603 +0xaf

Previous write by goroutine 184:
  net.setWriteDeadline()
      src/net/sockopt_posix.go:135 +0xdf
  net.setDeadline()
      src/net/sockopt_posix.go:144 +0x9c
  net.(*conn).SetDeadline()
      src/net/net.go:161 +0xe3
  net.func·061()
      src/net/timeout_test.go:616 +0x3ed

Goroutine 185 (running) created at:
  net.func·061()
      src/net/timeout_test.go:609 +0x288

Goroutine 184 (running) created at:
  net.TestProlongTimeout()
      src/net/timeout_test.go:618 +0x298
  testing.tRunner()
      src/testing/testing.go:301 +0xe8
</pre>

<h2 id="Options">Options</h2>

<p>
The <code>GORACE</code> environment variable sets race detector options.
The format is:
</p>

<pre>
GORACE="option1=val1 option2=val2"
</pre>

<p>
The options are:
</p>

<ul>
<li>
<code>log_path</code> (default <code>stderr</code>): The race detector writes
its report to a file named <code>log_path.<em>pid</em></code>.
The special names <code>stdout</code>
and <code>stderr</code> cause reports to be written to standard output and
standard error, respectively.
</li>

<li>
<code>exitcode</code> (default <code>66</code>): The exit status to use when
exiting after a detected race.
</li>

<li>
<code>strip_path_prefix</code> (default <code>""</code>): Strip this prefix
from all reported file paths, to make reports more concise.
</li>

<li>
<code>history_size</code> (default <code>1</code>): The per-goroutine memory
access history is <code>32K * 2**history_size elements</code>.
Increasing this value can avoid a "failed to restore the stack" error in reports, at the
cost of increased memory usage.
</li>

<li>
<code>halt_on_error</code> (default <code>0</code>): Controls whether the program
exits after reporting first data race.
</li>

<li>
<code>atexit_sleep_ms</code> (default <code>1000</code>): Amount of milliseconds
to sleep in the main goroutine before exiting.
</li>
</ul>

<p>
Example:
</p>

<pre>
$ GORACE="log_path=/tmp/race/report strip_path_prefix=/my/go/sources/" go test -race
</pre>

<h2 id="Excluding_Tests">Excluding Tests</h2>

<p>
When you build with <code>-race</code> flag, the <code>go</code> command defines additional
<a href="https://go.p2hp.com/pkg/go/build/#hdr-Build_Constraints">build tag</a> <code>race</code>.
You can use the tag to exclude some code and tests when running the race detector.
Some examples:
</p>

<pre>
// +build !race

package foo

// The test contains a data race. See issue 123.
func TestFoo(t *testing.T) {
	// ...
}

// The test fails under the race detector due to timeouts.
func TestBar(t *testing.T) {
	// ...
}

// The test takes too long under the race detector.
func TestBaz(t *testing.T) {
	// ...
}
</pre>

<h2 id="How_To_Use">How To Use</h2>

<p>
To start, run your tests using the race detector (<code>go test -race</code>).
The race detector only finds races that happen at runtime, so it can't find
races in code paths that are not executed.
If your tests have incomplete coverage,
you may find more races by running a binary built with <code>-race</code> under a realistic
workload.
</p>

<h2 id="Typical_Data_Races">Typical Data Races</h2>

<p>
Here are some typical data races.  All of them can be detected with the race detector.
</p>

<h3 id="Race_on_loop_counter">Race on loop counter</h3>

<pre>
func main() {
	var wg sync.WaitGroup
	wg.Add(5)
	for i := 0; i < 5; i++ {
		go func() {
			fmt.Println(i) // Not the 'i' you are looking for.
			wg.Done()
		}()
	}
	wg.Wait()
}
</pre>

<p>
The variable <code>i</code> in the function literal is the same variable used by the loop, so
the read in the goroutine races with the loop increment.
(This program typically prints 55555, not 01234.)
The program can be fixed by making a copy of the variable:
</p>

<pre>
func main() {
	var wg sync.WaitGroup
	wg.Add(5)
	for i := 0; i < 5; i++ {
		go func(j int) {
			fmt.Println(j) // Good. Read local copy of the loop counter.
			wg.Done()
		}(i)
	}
	wg.Wait()
}
</pre>

<h3 id="Accidentally_shared_variable">Accidentally shared variable</h3>

<pre>
// ParallelWrite writes data to file1 and file2, returns the errors.
func ParallelWrite(data []byte) chan error {
	res := make(chan error, 2)
	f1, err := os.Create("file1")
	if err != nil {
		res &lt;- err
	} else {
		go func() {
			// This err is shared with the main goroutine,
			// so the write races with the write below.
			_, err = f1.Write(data)
			res &lt;- err
			f1.Close()
		}()
	}
	f2, err := os.Create("file2") // The second conflicting write to err.
	if err != nil {
		res &lt;- err
	} else {
		go func() {
			_, err = f2.Write(data)
			res &lt;- err
			f2.Close()
		}()
	}
	return res
}
</pre>

<p>
The fix is to introduce new variables in the goroutines (note the use of <code>:=</code>):
</p>

<pre>
			...
			_, err := f1.Write(data)
			...
			_, err := f2.Write(data)
			...
</pre>

<h3 id="Unprotected_global_variable">Unprotected global variable</h3>

<p>
If the following code is called from several goroutines, it leads to races on the <code>service</code> map.
Concurrent reads and writes of the same map are not safe:
</p>

<pre>
var service map[string]net.Addr

func RegisterService(name string, addr net.Addr) {
	service[name] = addr
}

func LookupService(name string) net.Addr {
	return service[name]
}
</pre>

<p>
To make the code safe, protect the accesses with a mutex:
</p>

<pre>
var (
	service   map[string]net.Addr
	serviceMu sync.Mutex
)

func RegisterService(name string, addr net.Addr) {
	serviceMu.Lock()
	defer serviceMu.Unlock()
	service[name] = addr
}

func LookupService(name string) net.Addr {
	serviceMu.Lock()
	defer serviceMu.Unlock()
	return service[name]
}
</pre>

<h3 id="Primitive_unprotected_variable">Primitive unprotected variable</h3>

<p>
Data races can happen on variables of primitive types as well (<code>bool</code>, <code>int</code>, <code>int64</code>, etc.),
as in this example:
</p>

<pre>
type Watchdog struct{ last int64 }

func (w *Watchdog) KeepAlive() {
	w.last = time.Now().UnixNano() // First conflicting access.
}

func (w *Watchdog) Start() {
	go func() {
		for {
			time.Sleep(time.Second)
			// Second conflicting access.
			if w.last < time.Now().Add(-10*time.Second).UnixNano() {
				fmt.Println("No keepalives for 10 seconds. Dying.")
				os.Exit(1)
			}
		}
	}()
}
</pre>

<p>
Even such "innocent" data races can lead to hard-to-debug problems caused by
non-atomicity of the memory accesses,
interference with compiler optimizations,
or reordering issues accessing processor memory .
</p>

<p>
A typical fix for this race is to use a channel or a mutex.
To preserve the lock-free behavior, one can also use the
<a href="https://go.p2hp.com/pkg/sync/atomic/"><code>sync/atomic</code></a> package.
</p>

<pre>
type Watchdog struct{ last int64 }

func (w *Watchdog) KeepAlive() {
	atomic.StoreInt64(&amp;w.last, time.Now().UnixNano())
}

func (w *Watchdog) Start() {
	go func() {
		for {
			time.Sleep(time.Second)
			if atomic.LoadInt64(&amp;w.last) < time.Now().Add(-10*time.Second).UnixNano() {
				fmt.Println("No keepalives for 10 seconds. Dying.")
				os.Exit(1)
			}
		}
	}()
}
</pre>

<h3 id="Unsynchronized_send_and_close_operations">Unsynchronized send and close operations</h3>

<p>
As this example demonstrates, unsynchronized send and close operations
on the same channel can also be a race condition:
</p>

<pre>
c := make(chan struct{}) // or buffered channel

// The race detector cannot derive the happens before relation
// for the following send and close operations. These two operations
// are unsynchronized and happen concurrently.
go func() { c <- struct{}{} }()
close(c)
</pre>

<p>
According to the Go memory model, a send on a channel happens before
the corresponding receive from that channel completes. To synchronize
send and close operations, use a receive operation that guarantees
the send is done before the close:
</p>

<pre>
c := make(chan struct{}) // or buffered channel

go func() { c <- struct{}{} }()
<-c
close(c)
</pre>

<h2 id="Requirements">Requirements</h2>

<p>
  The race detector requires cgo to be enabled and supports
  <code>linux/amd64</code>, <code>linux/ppc64le</code>,
  <code>linux/arm64</code>, <code>freebsd/amd64</code>,
  <code>netbsd/amd64</code>, <code>darwin/amd64</code>,
  <code>darwin/arm64</code>, and <code>windows/amd64</code>.
</p>

<h2 id="Runtime_Overheads">Runtime Overhead</h2>

<p>
The cost of race detection varies by program, but for a typical program, memory
usage may increase by 5-10x and execution time by 2-20x.
</p>

<p>
The race detector currently allocates an extra 8 bytes per <code>defer</code>
and <code>recover</code> statement. Those extra allocations <a
href="https://go.p2hp.com/issue/26813">are not recovered until the goroutine
exits</a>. This means that if you have a long-running goroutine that is
periodically issuing <code>defer</code> and <code>recover</code> calls,
the program memory usage may grow without bound. These memory allocations
will not show up in the output of <code>runtime.ReadMemStats</code> or
<code>runtime/pprof</code>.
</p>


</article>



</main>
<footer class="Site-footer">
  <div class="Footer">
    <div class="Container">
      <div class="Footer-links">
          <div class="Footer-linkColumn">
            <a href="https://go.p2hp.com/solutions/"  target="" class="Footer-link Footer-link--primary">
              为什么用Go
            </a>
              <a href="https://go.p2hp.com/solutions/#use-cases"  target="" class="Footer-link">
                用例
              </a>
              <a href="https://go.p2hp.com/solutions/#case-studies"  target="" class="Footer-link">
                实例探究
              </a>
          </div>
          <div class="Footer-linkColumn">
            <a href="https://go.p2hp.com/learn/"  target="" class="Footer-link Footer-link--primary">
              快速开始
            </a>
              <a href="https://go.p2hp.com/play"  target="" class="Footer-link">
                在线运行
              </a>
              <a href="https://go.p2hp.com/tour/"  target="" class="Footer-link">
                边学边练
              </a>
              <a href="https://stackoverflow.com/questions/tagged/go?tab=Newest"  target="_blank" class="Footer-link">
                Stack Overflow
              </a>
              <a href="https://go.p2hp.com/help/"  target="" class="Footer-link">
                帮助
              </a>
          </div>
          <div class="Footer-linkColumn">
            <a href="https://pkg.go.dev"  target="_blank" class="Footer-link Footer-link--primary">
              包
            </a>
              <a href="https://go.p2hp.com/pkg/"  target="_blank" class="Footer-link">
                标准库
              </a>
          </div>
          <div class="Footer-linkColumn">
            <a href="https://go.p2hp.com/project"  target="" class="Footer-link Footer-link--primary">
              关于
            </a>
              <a href="https://go.p2hp.com/dl/"  target="" class="Footer-link">
                下载
              </a>
              <a href="https://go.p2hp.com/blog/"  target="" class="Footer-link">
                博客
              </a>
              <a href="https://github.com/golang/go/issues"  target="_blank" class="Footer-link">
                问题追踪
              </a>
              <a href="../devel/release.html"  target="" class="Footer-link">
                发行说明
              </a>
              <a href="https://go.p2hp.com/blog/go-brand"  target="_blank" class="Footer-link">
                品牌指南
              </a>
              <a href="https://go.p2hp.com/conduct"  target="" class="Footer-link">
                行为守则
              </a>
          </div>
          <div class="Footer-linkColumn">
            <a href="race_detector.html"  target="_blank" class="Footer-link Footer-link--primary">
              连接
            </a>
              <a href="https://github.com/golang"  target="_blank" class="Footer-link">
                GitHub
              </a>
              <a href="https://invite.slack.golangbridge.org/"  target="_blank" class="Footer-link">
                Slack
              </a>
              <a href="https://www.meetup.com/pro/go"  target="_blank" class="Footer-link">
                Meetup
              </a>
              <a href="https://golangweekly.com/"  target="_blank" class="Footer-link">
                Golang Weekly
              </a>
          </div>
      </div>
    </div>
  </div>
  <div class="Footer">
    <div class="Container Container--fullBleed">
      <div class="Footer-bottom">
        <img class="Footer-gopher" src="../../go.dev/images/gophers/pilot-bust.svg" alt="The Go Gopher">
        <ul class="Footer-listRow">
          <li class="Footer-listItem">
            <a href="https://go.p2hp.com/copyright">版权</a>
          </li>
          <li class="Footer-listItem">
            <a href="https://go.p2hp.com/tos">服务条款</a>
          </li>
          <li class="Footer-listItem">
            <a href="https://www.p2hp.com/privacy-policy.php"
              target="_blank"
              rel="noopener">
              隐私政策
            </a>
            </li>
            <li class="Footer-listItem">
            <a href="https://go.p2hp.com/sitemap"
              target="_blank"
              rel="noopener">
              网站地图
            </a>
            </li>
          
          <li class="Footer-listItem">
            <a
              href="https://go.p2hp.com/lianxi"
              target="_blank"
              >
              联系本站
            </a>
          </li>
          <li class="Footer-listItem">
            
              <a href="https://go.p2hp.com">Go中文网</a>版权所有 © 2021-2023
             
          </li>
          <li class="Footer-listItem">
            
              由 Lenix 建立和翻译 <span style="color: #e27575;font-size: 14px;">❤</span>
             
          </li>
          <li class="Footer-listItem">
            
              请按Ctrl+D试试
             
          </li>
          <li class="Footer-listItem go-Footer-listItem">
            <button class="go-Button go-Button--text go-Footer-toggleTheme js-toggleTheme" aria-label="Toggle theme">
              <img
                data-value="auto"
                class="go-Icon go-Icon--inverted"
                height="24"
                width="24"
                src="../../go.dev/images/icons/brightness_6_gm_grey_24dp.svg"
                alt="System theme">
              <img
                data-value="dark"
                class="go-Icon go-Icon--inverted"
                height="24"
                width="24"
                src="../../go.dev/images/icons/brightness_2_gm_grey_24dp.svg"
                alt="Dark theme">
              <img
                data-value="light"
                class="go-Icon go-Icon--inverted"
                height="24"
                width="24"
                src="../../go.dev/images/icons/light_mode_gm_grey_24dp.svg"
                alt="Light theme">
            </button>
          </li>
        </ul>
        <a class="Footer-googleLogo" target="_blank" href="https://go.p2hp.com" rel="noopener">
          <img class="Footer-googleLogoImg" src="../../go.dev/images/go-white.png" alt="go中文网 logo">
        </a>
      </div>
    </div>
  </div>
  <script src="../../go.dev/js/jquery.js"></script>
  <script src="../../go.dev/js/carousels.js"></script>
  <script src="../../go.dev/js/searchBox.js"></script>
  <script src="../../go.dev/js/misc.js"></script>
  <script src="../../go.dev/js/hats.js"></script>
  <script src="../../go.dev/js/playground.js"></script>
  <script src="../../go.dev/js/godocs.js"></script>
</footer>
</body>
</html>














